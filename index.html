<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=7,IE=9">
	<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

	<title>ArcGIS MapSync</title>

	<link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/css/esri.css">
	<script>var dojoConfig = {parseOnLoad: true};</script>
	<script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/"></script>
	<link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/dojo/dijit/themes/claro/claro.css">
	
    <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
    <style>
      html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
      #mapDiv{
        padding:0;
      }
    </style>

	<script>
    	dojo.require("dijit.layout.BorderContainer");
    	dojo.require("dijit.layout.ContentPane");

		// Some globals for the map, and for graphics to update/remove
		var map;
		var visibleAreaGraphic;
		var searchGraphics = [];

		// Connect to Firebase
		var demoSession = 'tcdemo';
		var demoMapSync = new Firebase('https://mapsync.firebaseio.com/sessions/' + demoSession);

		// When we're ready...
		function init() {
			require(["esri/arcgis/utils"],function(arcGISUtils)
			{
				// Open a WebMap
				var mapDeferred = esri.arcgis.utils.createMap("282c305a0b9244f788c036741ae2f9aa", "mapDiv");

				mapDeferred.then(function(response)
				{
					map = response.map;

					// Respond to Firebase update to the visible extent
					demoMapSync.child('visibleArea').on('value', function(snapshot)
					{
						if (snapshot.val() !== null)
						{
							// Turn the JSON string from Firebase into a JSON Object
							var visibleAreaPolyJSON = jQuery.parseJSON(snapshot.val());
							require(["esri/graphic","esri/symbols/SimpleLineSymbol",
									 "esri/geometry/Polygon","esri/geometry/Extent","dojo/_base/Color"],
								function(Graphic,SimpleLineSymbol,Polygon,Extent,Color)
								{
									// Remove any old view area display
									map.graphics.remove(visibleAreaGraphic);
									
									// Load the JSON Object into a Polygon
									var visibleAreaPoly = new Polygon(visibleAreaPolyJSON);
									// Create a symbol to display the outline
									var outlineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
																			 new Color([100,100,100,0.92]),
																 			 2);
									// Create a graphic (geometry + symbol)
									visibleAreaGraphic = new Graphic(visibleAreaPoly, outlineSymbol);
									// Add it to the map
									map.graphics.add(visibleAreaGraphic);
									// Zoom the map appropriately
									map.setExtent(visibleAreaPoly.getExtent(), true);
							});
						}
					});

					// Respond to Firebase update to a map tap
					demoMapSync.child('tapGraphic').on('value', function(snapshot)
					{
						if (snapshot.val() !== null)
						{
							// Turn the JSON string from Firebase into a JSON Object
							var tapPointJSON = jQuery.parseJSON(snapshot.val());
							require(["esri/graphic"], function(Graphic)
							{
								// Remove any old tap or service results graphics.
								for (i=0; i < searchGraphics.length; i++)
								{
									map.graphics.remove(searchGraphics[i]);
								}
								// Load the JSON from Firebase into a Graphic
								var tapGraphic = new Graphic(tapPointJSON);
								// And add it to the map display
								map.graphics.add(tapGraphic);
								searchGraphics.push(tapGraphic);
							});
						}
					});

					// Respond to a Firebase update for geoservice results
					demoMapSync.child('resultGraphics').on('value', function(snapshot)
					{
						if (snapshot.val() !== null)
						{
							var resultGraphics = snapshot.val();

							require(["esri/graphic"], function(Graphic)
							{
								for (i=0; i < resultGraphics.length; i++)
								{
									// Turn the JSON string from Firebase into a JSON Object
									var routeGraphicJSON = jQuery.parseJSON(resultGraphics[i]);
									// Create a graphic from the JSON Object
									var routeGraphic = new Graphic(routeGraphicJSON);
									// Add it to the map display
									map.graphics.add(routeGraphic);
									// Store it for later deletion
									searchGraphics.push(routeGraphic);
								}
							});
						}
					});
					
					demoMapSync.child('active').on('value', function(snapshot)
					{
						if (snapshot.val() === null)
						{
							map.graphics.setOpacity(0.5);
						}
						else
						{
							map.graphics.setOpacity(1);
						}
					});

				}, function(error) {
					console.log("Map creation failed: ", dojo.toJson(error));
				});
			});
		}

		dojo.ready(init);
	</script>
</head>
<body class="claro">
	<div data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design:'headline', gutters:false"
		 style="width: 100%; height: 100%; margin: 0;">
		  <div id="mapDiv" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" />
	</div>
</body>
</html>